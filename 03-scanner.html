<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escanear Modelo 3D - Estilo Dashboard</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>Visor <b>3D AR</b></h1>
        </header>

        <div id="scanner-view">
            <div id="reader"></div>
            <p class="instruction-text">Apunta al c√≥digo QR de tu modelo en GitHub</p>
        </div>

        <div id="model-view" style="display: none; position: relative;">
            
            <div id="loading-screen" style="display: none;">
                <div class="spinner"></div>
                <p>Descargando modelo...</p>
            </div>

            <div id="error-message" style="display: none;"></div>

            <model-viewer 
                id="viewer"
                src="" 
                ar 
                ar-modes="webxr scene-viewer quick-look" 
                camera-controls 
                auto-rotate> 
                <button slot="ar-button" class="ar-button">üì∑ VER EN TU ESPACIO</button>
            </model-viewer>
            
            <button id="btn-reload" class="action-button">Escanear otro c√≥digo</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="02-dashboard.html" class="nav-item">
            <span>üè†</span><span class="nav-label">Inicio</span>
        </a>
        <a href="#" class="nav-item active">
            <span>üì∑</span><span class="nav-label">Escanear</span>
        </a>
        <a href="04-passport.html" class="nav-item">
            <span>üó∫Ô∏è</span><span class="nav-label">Pasaporte</span>
        </a>
        <a href="10-perfil.html" class="nav-item">
            <span>üë§</span><span class="nav-label">Perfil</span>
        </a>
    </nav>

    <audio id="coin-sound" src="https://www.myinstants.com/media/sounds/super-mario-coin.mp3"></audio>

    <style>
    :root {
        --primary-teal: #4db6ac;
        --nav-bg: #ffffff;
        --text-dark: #333;
        --glass-bg: rgba(255, 255, 255, 0.70);
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0; padding: 0;
        min-height: 100vh;
        display: flex; align-items: center; justify-content: center;
        background: url('Fondo_Blanco_AzulMaya.png') center/cover no-repeat fixed;
        padding-bottom: 100px;
    }

    .container {
        width: 90%; max-width: 500px; padding: 40px;
        background-color: var(--glass-bg);
        border-radius: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        backdrop-filter: blur(8px);
        text-align: center;
    }

    #reader { border-radius: 20px; overflow: hidden; border: none !important; }

    model-viewer {
        width: 100%; height: 350px;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 20px; margin-bottom: 20px;
    }

    /* Estilos del Spinner de Carga */
    #loading-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 350px;
        background: rgba(255, 255, 255, 0.9);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        z-index: 10; border-radius: 20px;
    }

    .spinner {
        width: 40px; height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-teal);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #error-message { color: #d32f2f; font-weight: bold; margin-bottom: 15px; }

    .ar-button {
        background-color: var(--primary-teal); color: white; border: none;
        padding: 12px 20px; border-radius: 25px; font-weight: bold;
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    }

    .action-button { background: var(--text-dark); color: white; border: none; padding: 10px 20px; border-radius: 10px; }

    /* Estilo de la Navegaci√≥n */
    nav.bottom-nav {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: var(--nav-bg); height: 80px;
        display: flex; justify-content: center; align-items: center; gap: 50px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000;
    }

    .nav-item { text-decoration: none; color: #aaa; display: flex; flex-direction: column; align-items: center; }
    .nav-item.active { color: var(--text-dark); background: #f0f0f0; border-radius: 15px; padding: 10px; }
    .nav-label { font-size: 10px; font-weight: bold; margin-top: 4px; }
</style>

    <script>
    // 1. Inicializar Esc√°ner
    let html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", { fps: 15, qrbox: {width: 250, height: 250} }
    );

    function onScanSuccess(decodedText) {
        console.log("Detectado: " + decodedText);
        
        // Reproducir sonido de moneda
        const sound = document.getElementById('coin-sound');
        if(sound) sound.play();

        // Limpiar URL de GitHub
        let cleanLink = decodedText.trim();
        if (cleanLink.includes("github.com") && cleanLink.includes("/blob/")) {
            cleanLink = cleanLink.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
        }

        // Alternar vistas
        html5QrcodeScanner.clear();
        document.getElementById('scanner-view').style.display = 'none';
        document.getElementById('model-view').style.display = 'block';
        
        // Mostrar carga
        const loader = document.getElementById('loading-screen');
        if(loader) loader.style.display = 'flex';
        document.getElementById('error-message').style.display = 'none';

        // Cargar Modelo
        const viewer = document.getElementById('viewer');
        viewer.src = cleanLink;

        // Ocultar carga al terminar
        viewer.addEventListener('load', () => {
            if(loader) loader.style.display = 'none';
        });

        // Manejar Errores
        viewer.addEventListener('error', () => {
            if(loader) loader.style.display = 'none';
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = "‚ùå Error: El enlace del QR no contiene un modelo 3D v√°lido.";
        });
    }

    html5QrcodeScanner.render(onScanSuccess);

    // Bot√≥n Reload
    document.getElementById('btn-reload').addEventListener('click', () => {
        location.reload();
    });
</script>
</body>
</html>