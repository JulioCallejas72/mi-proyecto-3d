<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escanear Modelo 3D - Estilo Dashboard</title>
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>

    <div class="container">
    <header>
        <h1>Visor <b>3D AR</b></h1>
    </header>

    <div id="scanner-view">
        <div id="reader"></div>
        <p style="margin-top: 15px; font-size: 0.9rem; color: #555;">
            Escanea el QR de tu modelo .glb en GitHub
        </p>
    </div>

    <div id="model-view" style="display: none; position: relative;">
        
        <div id="loading-screen">
            <div class="spinner"></div>
            <p>Descargando modelo...</p>
        </div>

        <div id="error-message" style="display: none; color: #d32f2f; padding: 20px;">
            <p>‚ùå Error al cargar el modelo. Revisa el enlace o tu conexi√≥n.</p>
        </div>

        <model-viewer 
            id="viewer"
            src="" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            auto-rotate> 
            <button slot="ar-button" class="ar-button">üì∑ VER EN TU ESPACIO</button>
        </model-viewer>
        
        <button id="btn-reload" class="action-button">Escanear otro c√≥digo</button>
    </div>
</div>

<audio id="coin-sound" src="https://www.myinstants.com/media/sounds/super-mario-coin.mp3"></audio>

<style>
    #loading-screen {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 350px;
    background: rgba(255, 255, 255, 0.9);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 10; border-radius: 20px;
}

.spinner {
    width: 40px; height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-teal);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
    const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
    const coinSound = document.getElementById('coin-sound');

    function onScanSuccess(decodedText) {
        let cleanLink = decodedText.trim();
        
        // Correcci√≥n de enlaces de GitHub
        if (cleanLink.includes("github.com") && cleanLink.includes("/blob/")) {
            cleanLink = cleanLink.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
        }

        coinSound.play();
        scanner.clear();
        
        document.getElementById('scanner-view').style.display = 'none';
        document.getElementById('model-view').style.display = 'block';
        document.getElementById('loading-screen').style.display = 'flex';
        document.getElementById('error-message').style.display = 'none';

        const viewer = document.getElementById('viewer');
        viewer.src = cleanLink;

        // √âxito: Ocultar carga al terminar
        viewer.addEventListener('load', () => {
            document.getElementById('loading-screen').style.display = 'none';
        });

        // Error: Mostrar mensaje si el link falla
        viewer.addEventListener('error', (err) => {
            console.error("Fallo al cargar:", err);
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
        });
    }

    scanner.render(onScanSuccess);
</script>
</body>
</html>